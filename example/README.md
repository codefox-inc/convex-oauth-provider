# OAuth Provider Example

This example demonstrates the OAuth 2.1/OpenID Connect Provider with:
- **Frontend**: React + Vite (Task Manager UI)
- **Backend**: Convex (OAuth endpoints + Task API)
- **MCP Server**: Cloudflare Workers (Model Context Protocol for AI agents)

## Architecture

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   React App     │     │  Convex Backend │     │  MCP Server     │
│  (Anonymous)    │────▶│  (OAuth + Tasks)│◀────│ (Cloudflare)    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
       │                         │                       │
       │ Session Cookie          │ Access Token          │ Bearer Auth
       ▼                         ▼                       ▼
   Anonymous Auth          OAuth Provider           Task CRUD API
```

## Setup

### 1. Install Dependencies

From the project root:

```bash
npm install
```

### 2. Configure Environment Variables

#### Convex Backend (`.env.local` in project root)

`npx convex dev` will automatically create `.env.local` with `CONVEX_DEPLOYMENT`, `CONVEX_URL`, and `CONVEX_SITE_URL`.

**Important:** You must manually add `VITE_CONVEX_URL` for the React frontend:

```bash
# Auto-generated by convex dev
CONVEX_DEPLOYMENT=dev:your-deployment
CONVEX_URL=https://your-deployment.convex.cloud
CONVEX_SITE_URL=https://your-deployment.convex.site

# Add this manually - Vite requires VITE_ prefix
VITE_CONVEX_URL=https://your-deployment.convex.cloud
```

**Set Convex environment variables** (backend configuration):

```bash
npx convex env set SITE_URL http://localhost:5173
# For production:
# npx convex env set SITE_URL https://your-app.com --prod
```

#### Cloudflare Worker (`example/.dev.vars`)

Copy the example file and fill in your values:

```bash
cd example
cp .dev.vars.example .dev.vars
```

Edit `.dev.vars`:

```bash
CONVEX_URL=https://your-deployment.convex.cloud
CONVEX_SITE_URL=https://your-deployment.convex.site
SITE_URL=http://localhost:8787
```

### 3. Initialize Convex

```bash
npm run build
npx convex dev --once
```

## Development

Start all services (from project root):

```bash
npm run dev
```

This starts:
- **Convex Backend**: Watches for changes
- **Frontend** (http://localhost:5173): Vite dev server
- **MCP Server** (http://localhost:8787): Cloudflare Workers
- **Build Watcher**: Auto-rebuilds on code changes

## Try the Live Demo

**Web UI:**
https://oauth-provider-example.codefox-inc.workers.dev

**Claude Code:**
```bash
claude mcp add --transport http example https://oauth-provider-example.codefox-inc.workers.dev/mcp
```

**Codex:**
```bash
codex mcp add example --url https://oauth-provider-example.codefox-inc.workers.dev/mcp
```

After adding MCP, use tools like `task-list`, `task-create`, etc. OAuth authorization will be handled automatically.

---

## Local Development

### Web UI

1. Open http://localhost:5173
2. Sign in anonymously
3. Create tasks using the UI
4. View connected apps in the "Connected Apps" section

### MCP (Model Context Protocol)

Register the MCP server with Claude:

```bash
claude mcp add --transport http tasks-local http://localhost:8787/mcp
```

OAuth authorization flow:
1. Claude CLI initiates OAuth flow
2. Browser opens `https://{deployment}.convex.site/oauth/authorize`
3. Convex redirects to `http://localhost:5173/oauth/authorize` (consent UI)
4. User approves → redirects back to Convex → MCP server receives tokens

Use MCP tools via Claude:
- `task-list`: Get all tasks
- `task-create`: Create a new task
- `task-update`: Update task status/details
- `task-delete`: Delete a task

The MCP client uses Dynamic Client Registration (DCR), so you do not need to manually register a client.

## Files

### Frontend (`src/`)
- `App.tsx` - Task Manager UI
- `OAuthConsent.tsx` - OAuth Authorization Page

### Convex Backend (`convex/`)
- `http.ts` - OAuth routes
- `tasks.ts` - Task CRUD (supports OAuth & session)
- `oauth.ts` - User authorization management
- `auth.ts` - Convex Auth configuration (anonymous provider)

### MCP Server (`worker/`)
- `index.ts` - Hono app
- `routes/oauth-discovery.ts` - `/.well-known/oauth-*` endpoints
- `routes/mcp.ts` - `/mcp` endpoint
- `mcp/server.ts` - MCP server setup
- `mcp/tools/task.ts` - Task management tools

## Authentication Flow

1. **Anonymous Login** (Frontend):
   - User signs in via Convex Auth (anonymous provider)
   - Session stored in cookies

2. **OAuth Authorization** (MCP):
   - MCP client discovers OAuth endpoints via `/.well-known/oauth-authorization-server`
   - Redirects user to `/oauth/authorize`
   - User approves consent
   - MCP receives access token

3. **Unified Access** (Tasks):
   - `tasks.ts` supports both session tokens and OAuth tokens
   - Same user, same data, different authentication methods

## Endpoints

### Frontend (http://localhost:5173)
- `/` - Task Manager
- `/oauth/authorize` - OAuth Consent Page

### Convex Site (https://your-deployment.convex.site)
- `/oauth/authorize` - OAuth Authorization
- `/oauth/token` - Token Endpoint
- `/oauth/userinfo` - UserInfo Endpoint
- `/oauth/.well-known/jwks.json` - JWKS
- `/oauth/register` - Client Registration

### Worker (http://localhost:8787)
- `/.well-known/oauth-authorization-server` - OAuth Discovery
- `/.well-known/oauth-protected-resource` - Protected Resource Discovery
- `/mcp` - MCP Server Endpoint

## Troubleshooting

### "Protected resource does not match" error

Ensure `.dev.vars` has `SITE_URL=http://localhost:8787` (Worker URL, not Frontend URL)

### OAuth consent shows black screen

Check `example/src/App.css` - the `.oauth-consent` class should have styling

### MCP tools not working

1. Check MCP server is running on port 8787
2. Verify OAuth consent was approved
3. Check access token is valid: `claude mcp list`
